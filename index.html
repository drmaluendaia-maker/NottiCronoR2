<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cronogramas PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .weekend-day { background-color: #fef3c7; }
        .holiday-day { background-color: #fecaca; border: 1px solid #dc2626; }
        .header-day { background-color: #f3f4f6; }
        .modal-backdrop, .day-modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; justify-content: center; align-items: center; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        #app-container { display: none; }
        .toast-notification { position: fixed; bottom: 20px; right: 20px; background-color: #2d3748; color: white; padding: 12px 20px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(20px); }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .slot-input { width: 40px; text-align: center; border-radius: 4px; border: 1px solid #ccc; }
        .filtered-out { opacity: 0.25; }
        .accordion-content { display: none; }
        .accordion-arrow { transition: transform 0.2s ease-in-out; }
        .accordion-header.active .accordion-arrow { transform: rotate(180deg); }
        
        /* --- Tooltip Styles --- */
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 240px; background-color: #374151; color: #fff; text-align: center; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 10; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4; font-weight: 400; box-shadow: 0 4px 6px rgba(0,0,0,0.1); bottom: 125%; left: 50%; transform: translateX(-50%); }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #374151 transparent transparent transparent; }
        .tooltip-left .tooltiptext { bottom: 50%; right: 125%; left: auto; transform: translateY(50%); }
        .tooltip-left .tooltiptext::after { top: 50%; left: 100%; right: auto; margin-top: -5px; margin-left: 0; border-color: transparent transparent transparent #374151; }
        .tooltip-right .tooltiptext { bottom: 50%; left: 125%; transform: translateY(50%); }
        .tooltip-right .tooltiptext::after { top: 50%; right: 100%; left: auto; margin-top: -5px; margin-left: 0; border-color: transparent #374151 transparent transparent; }

        /* --- Drag and Drop & Validation Styles --- */
        .resident-chip { cursor: grab; padding: 2px 4px; }
        .resident-chip.dragging { opacity: 0.5; cursor: grabbing; }
        .drag-over { background-color: #dbeafe !important; border: 2px dashed #60a5fa !important; }
        .successful-swap { background-color: #dcfce7 !important; color: #166534 !important; } /* green */
        .sandwich-shift { background-color: #fce7f3 !important; color: #9d174d !important; } /* pink */
        .duplicate-shift { background-color: #fee2e2 !important; color: #991b1b !important; } /* red */
        .resident-chip-container { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .revert-btn { cursor: pointer; color: #b91c1c; font-weight: bold; padding-left: 6px; font-size: 1.1rem; line-height: 1; }
        .revert-btn:hover { color: #7f1d1d; }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="fixed top-0 left-0 w-full h-full bg-blue-900 flex justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm text-center mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Acceso Restringido</h2>
            <p class="text-gray-600 mb-6">Introduce la contraseña para continuar.</p>
            <form id="login-form">
                <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Contraseña">
                <p id="error-message" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-4">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <main id="app-container">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8">
                <img src="notti.png" alt="Logo Hospital Notti" class="h-20 mx-auto mb-4" onerror="this.style.display='none'">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-800">Generador de Cronogramas PRO</h1>
                <p class="text-md text-gray-600 mt-1">Hospital Notti - Pediatría</p>
            </header>

            <!-- Controles Principales -->
            <div class="controls bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label for="month-select" class="block text-sm font-medium">Mes:</label><select id="month-select" class="mt-1 block w-full rounded-md"></select></div>
                    <div><label for="year-input" class="block text-sm font-medium">Año:</label><input type="number" id="year-input" value="2025" class="mt-1 block w-full rounded-md"></div>
                    <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Generar Cronograma</button>
                </div>
                <!-- NUEVO: Contador de Cupos -->
                <div id="slot-counter-display" class="mt-4 pt-4 border-t border-gray-200 text-center">
                    <span class="text-sm font-medium text-gray-700">Cupos Totales del Mes: </span>
                    <span class="text-sm ml-2">Semana: <b id="weekday-slot-count" class="text-blue-600 text-base">0</b></span>
                    <span class="text-sm ml-4">Finde/Feriado: <b id="weekend-slot-count" class="text-red-600 text-base">0</b></span>
                </div>
            </div>

            <!-- Acordeón de Configuración -->
            <div class="space-y-4 mb-6">
                <!-- Configuración Avanzada -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700">Configuración Avanzada</h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content p-4 border-t">
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-md font-semibold text-gray-800 flex items-center gap-2">
                                    Descansos Previos
                                    <div class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="tooltiptext">Introduce los nombres de los residentes que estuvieron de guardia en los últimos dos días del mes anterior para asegurar que tengan su descanso correspondiente.</span>
                                    </div>
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label id="second-last-day-label" for="second-last-day-shifts" class="block text-sm font-medium">Guardias del día anterior al último</label>
                                        <input type="text" id="second-last-day-shifts" placeholder="Nombres separados por comas" class="mt-1 block w-full rounded-md">
                                    </div>
                                    <div>
                                        <label id="last-day-label" for="last-day-shifts" class="block text-sm font-medium">Guardias del último día</label>
                                        <input type="text" id="last-day-shifts" placeholder="Nombres separados por comas" class="mt-1 block w-full rounded-md">
                                    </div>
                                </div>
                            </div>
                             <div>
                                <h4 class="text-md font-semibold text-gray-800 flex items-center gap-2">
                                    Objetivo de Guardias (por defecto)
                                    <div class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="tooltiptext">Establece el número deseado de guardias por residente. El algoritmo intentará cumplir este objetivo, pero la equidad y la cobertura total de cupos tienen prioridad.</span>
                                    </div>
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label for="target-weekday-shifts" class="block text-sm font-medium">Guardias en semana</label>
                                        <input type="number" id="target-weekday-shifts" value="4" min="0" class="mt-1 block w-full rounded-md">
                                    </div>
                                    <div>
                                        <label for="target-weekend-shifts" class="block text-sm font-medium">Guardias en finde/feriado</label>
                                        <input type="number" id="target-weekend-shifts" value="2" min="0" class="mt-1 block w-full rounded-md">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="holidays-input" class="block text-sm font-medium flex items-center gap-2">
                                    Días Feriados (separados por comas)
                                    <div class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="tooltiptext">Introduce los números de los días del mes que son feriados, separados por comas. Estos días contarán como 'finde/feriado' para el cómputo de guardias.</span>
                                    </div>
                                </label>
                                <input type="text" id="holidays-input" placeholder="Ej: 1, 17, 25" class="mt-1 block w-full rounded-md">
                            </div>
                             <div class="flex flex-wrap justify-center gap-3">
                                <button id="export-png-btn" class="flex-grow sm:flex-grow-0 bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md">Exportar PNG</button>
                                <button id="export-pdf-btn" class="flex-grow sm:flex-grow-0 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-md">Exportar PDF</button>
                                <div class="flex items-center gap-2"><input type="checkbox" id="include-summary-pdf" class="rounded"><label for="include-summary-pdf" class="text-sm">Incluir resumen</label></div>
                            </div>
                            <div class="flex flex-wrap justify-center gap-3">
                                <button id="export-config-btn" class="flex-grow sm:flex-grow-0 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Exportar Config</button>
                                <label for="import-config-input" class="flex-grow sm:flex-grow-0 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md cursor-pointer">Importar Config</label>
                                <input type="file" id="import-config-input" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cupos por Día -->
                <div id="slots-config-container" class="bg-white rounded-lg shadow-md">
                     <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                            Configuración de Cupos por Día
                            <div class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Especifica cuántos residentes se necesitan para la guardia de cada día del mes. Puedes cambiar los valores y se guardarán automáticamente para este mes.</span>
                            </div>
                        </h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content p-4 border-t">
                        <p class="text-sm text-gray-600 mb-4">Define el número de residentes para cada día. Los cambios se guardan.</p>
                        <div id="slots-calendar-grid" class="grid grid-cols-7 gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Área de Validación -->
            <div id="validation-container" class="bg-white p-4 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
                    Área de Validación
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="tooltiptext">Aquí se mostrarán validaciones automáticas sobre el cronograma generado, como el cumplimiento de los descansos (guardias "sándwich") y las asignaciones/bloqueos obligatorios.</span>
                    </div>
                </h3>
                <div id="validation-list" class="space-y-2"></div>
            </div>

            <!-- Calendario de Cronograma -->
            <div id="schedule-container" class="bg-white p-4 rounded-lg shadow-lg mb-6">
                <h2 id="calendar-title" class="text-2xl font-semibold text-center mb-4"></h2>
                 <!-- Filtros Rápidos de Residentes -->
                <div id="resident-quick-filter-container" class="mb-4">
                    <p class="text-sm font-medium text-gray-600 mb-2 flex items-center">
                        Filtrar por residente:
                        <div class="tooltip ml-1 tooltip-right">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span class="tooltiptext">Haz clic en los nombres para resaltar sus guardias. Puedes seleccionar varios a la vez. Esto también sirve para filtrar la exportación a iCal.</span>
                        </div>
                    </p>
                    <div id="resident-quick-filter" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-xs sm:text-sm"></div>
            </div>

            <!-- Resumen de Criterios Individuales -->
             <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                        Resumen de Criterios Individuales
                        <div class="tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span class="tooltiptext">Un resumen de todas las reglas y preferencias especiales que has configurado, y si se cumplieron (verde) o no (rojo) en el cronograma actual.</span>
                        </div>
                    </h3>
                    <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="criteria-summary-container" class="accordion-content p-4 border-t">
                    <div id="criteria-summary-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm"></div>
                </div>
            </div>
            
            <!-- Acordeones de Gestión -->
            <div class="space-y-4">
                 <!-- Cambios Voluntarios -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                            Cambios Voluntarios (Arrastrar y Soltar)
                            <div class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">La forma más fácil de hacer cambios. Simplemente haz clic en el nombre de un residente, arrástralo y suéltalo sobre el nombre de otro para intercambiar sus guardias.</span>
                            </div>
                        </h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="swap-container" class="accordion-content p-4 border-t">
                        <h4 class="font-semibold text-gray-800">¿Cómo hacer un cambio?</h4>
                        <p class="text-sm text-gray-600 mt-2">Simplemente arrastra el nombre de un residente desde su día de guardia y suéltalo sobre el nombre de otro residente en un día diferente. El sistema intercambiará sus guardias automáticamente.</p>
                        <div class="mt-4 border-t pt-4">
                             <h4 class="font-semibold">Historial de Cambios:</h4>
                             <div id="drag-swaps-list" class="mt-2 space-y-2 max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
                 <!-- Grupos de Trabajo -->
                <div class="bg-white rounded-lg shadow-md">
                     <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                            Grupos de Trabajo
                            <div class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Crea grupos de residentes que prefieren trabajar juntos. El algoritmo intentará que coincidan en las mismas guardias cuando sea posible.</span>
                            </div>
                        </h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="groups-container" class="accordion-content p-4 border-t">
                        <div class="flex flex-col md:flex-row gap-4 items-start">
                             <div class="w-full md:w-1/2 md:pr-4">
                                <label for="group-name" class="block text-sm font-medium">Nombre del Grupo</label>
                                <input type="text" id="group-name" class="mt-1 block w-full rounded-md">
                                <label class="block text-sm font-medium mt-2">Miembros</label>
                                <div id="group-members-checklist" class="mt-1 max-h-40 overflow-y-auto border rounded-md p-2 space-y-1"></div>
                                <button id="create-group-btn" class="mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Crear Grupo</button>
                            </div>
                            <div id="groups-list" class="w-full md:w-1/2 mt-4 md:mt-0">
                                <p class="text-sm font-medium">Grupos existentes:</p>
                                <div id="groups-display" class="mt-2 space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Exportación de Calendario -->
                <div class="bg-white rounded-lg shadow-md">
                     <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                            Exportación de Calendario iCal
                            <div class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Genera un archivo .ics que puedes importar en Google Calendar, Outlook o el calendario de tu móvil. Solo se exportarán los calendarios de los residentes que hayas seleccionado en los filtros rápidos.</span>
                            </div>
                        </h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content p-4 border-t text-center">
                         <button id="export-ical-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Exportar iCal para Residentes Filtrados</button>
                         <p class="text-xs text-gray-500 mt-2">Usa los filtros rápidos sobre el calendario para seleccionar qué residentes exportar.</p>
                    </div>
                </div>
                <!-- Gestión de Residentes -->
                <div class="bg-white rounded-lg shadow-md">
                     <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                            Gestión de Residentes
                             <div class="tooltip">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Añade o elimina residentes de la lista maestra. Los cambios se guardan permanentemente en la memoria de tu navegador.</span>
                            </div>
                        </h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="resident-management-container" class="accordion-content p-4 border-t">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="w-full md:w-1/2">
                                <form id="add-resident-form" class="flex gap-2">
                                    <input type="text" id="new-resident-name" class="flex-grow rounded-md" placeholder="Nombre del nuevo residente">
                                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Añadir</button>
                                </form>
                            </div>
                            <div class="w-full md:w-1/2">
                                <h4 class="font-semibold">Lista Actual:</h4>
                                <div id="resident-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto border p-2 rounded-md"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen por Residente -->
            <div id="summary-container" class="mt-6">
                 <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    Resumen y Preferencias por Residente
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="tooltiptext">Este es el resumen general de guardias por residente. Haz clic en el nombre de cualquiera para abrir una ventana y configurar sus preferencias y reglas individuales.</span>
                    </div>
                </h3>
                 <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
        <footer class="text-center mt-8 mb-4">
            <p class="text-sm text-gray-500">Creado por Dr. Maluenda</p>
        </footer>
    </main>

    <!-- Modals -->
    <div id="preferences-modal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl m-4 p-6 w-full max-w-2xl">
            <h3 class="text-2xl font-bold mb-4" id="modal-resident-name"></h3>
            <input type="hidden" id="modal-resident-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium flex items-center gap-2">
                            Estado
                            <div class="tooltip tooltip-right">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">'Activo' significa que el residente será incluido en la generación del cronograma. 'Licencia' lo excluye completamente.</span>
                            </div>
                        </label>
                        <select id="resident-status" class="mt-1 block w-full rounded-md">
                            <option value="active">Activo</option>
                            <option value="on_leave">Licencia / Fuera de Cronograma</option>
                        </select>
                    </div>
                     <div id="target-shifts-container" class="space-y-2 p-3 border rounded-md">
                        <p class="text-sm font-medium flex items-center gap-2">
                            Objetivo de Guardias Individual
                            <div class="tooltip tooltip-right">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Si un residente necesita hacer un número de guardias diferente al objetivo general, puedes especificarlo aquí. Déjalo en blanco para usar el valor por defecto.</span>
                            </div>
                        </p>
                         <p class="text-xs text-gray-500">Dejar en blanco para usar el valor por defecto.</p>
                        <div class="flex items-center gap-4"><label class="text-sm">Semana:</label><input type="number" id="individual-target-weekday" placeholder="Defecto" min="0" class="w-24 rounded-md"></div>
                        <div class="flex items-center gap-4"><label class="text-sm">Finde/Feriado:</label><input type="number" id="individual-target-weekend" placeholder="Defecto" min="0" class="w-24 rounded-md"></div>
                    </div>
                    <div id="equity-container" class="space-y-2 p-3 border rounded-md">
                        <p class="text-sm font-medium flex items-center gap-2">
                            Contadores de Equidad (historial)
                            <div class="tooltip tooltip-right">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Introduce cuántos Sábados, Domingos y Feriados ha hecho este residente en meses anteriores. El algoritmo usará esto para distribuir los días 'malos' de forma más justa.</span>
                            </div>
                        </p>
                        <div class="flex items-center gap-4"><label class="text-sm">Sábados:</label><input type="number" id="saturday-count" min="0" class="w-20 rounded-md"></div>
                        <div class="flex items-center gap-4"><label class="text-sm">Domingos:</label><input type="number" id="sunday-count" min="0" class="w-20 rounded-md"></div>
                        <div class="flex items-center gap-4"><label class="text-sm">Feriados:</label><input type="number" id="holiday-count" min="0" class="w-20 rounded-md"></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div id="days-preference-section">
                        <div><label class="block text-sm font-medium flex items-center gap-2">
                            Días preferidos
                            <div class="tooltip tooltip-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Días que el residente PREFERIRÍA tener guardia. El algoritmo le dará prioridad, pero no es obligatorio.</span>
                            </div>
                        </label><input type="text" id="preferred-days" class="mt-1 block w-full rounded-md"></div>
                        <div><label class="block text-sm font-medium mt-2 flex items-center gap-2">
                            Días a evitar
                            <div class="tooltip tooltip-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Días que el residente PREFERIRÍA NO tener guardia. El algoritmo intentará evitar asignárselos, pero no es obligatorio.</span>
                            </div>
                        </label><input type="text" id="avoid-days" class="mt-1 block w-full rounded-md"></div>
                        <div><label class="block text-sm font-medium text-red-700 mt-2 flex items-center gap-2">
                            Días bloqueados (Obligatorio)
                            <div class="tooltip tooltip-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">¡OBLIGATORIO! Días en los que el residente NO PUEDE hacer guardia bajo ninguna circunstancia (ej. examen, vacaciones).</span>
                            </div>
                        </label><input type="text" id="blocked-days" class="mt-1 block w-full border-red-300 rounded-md"></div>
                         <div>
                        <label class="block text-sm font-medium text-green-700 mt-2 flex items-center gap-2">
                            Asignaciones Manuales (Obligatorio)
                             <div class="tooltip tooltip-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">¡OBLIGATORIO! Días en los que el residente DEBE tener guardia. El algoritmo lo asignará aquí antes que nada.</span>
                            </div>
                        </label>
                        <input type="text" id="manual-assignments-input" placeholder="Ej: 5, 12, 23" class="mt-1 block w-full border-green-300 rounded-md shadow-sm">
                    </div>
                    </div>
                    <div id="avoid-residents-section">
                        <label class="block text-sm font-medium flex items-center gap-2">
                            Evitar trabajar con
                             <div class="tooltip tooltip-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="tooltiptext">Selecciona residentes con los que esta persona prefiere no compartir guardia. El algoritmo intentará no ponerlos juntos en el mismo día.</span>
                            </div>
                        </label>
                        <div id="avoid-residents-checklist" class="mt-1 max-h-32 overflow-y-auto border rounded-md p-2 space-y-1"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="modal-close-btn" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-md">Cancelar</button>
                <button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Guardar</button>
            </div>
        </div>
    </div>

    <div id="day-modal" class="day-modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-4 w-full max-w-xs mx-4">
            <h4 class="font-bold text-center mb-2" id="day-modal-title"></h4>
            <div class="space-y-2">
                <select id="day-modal-resident-select" class="w-full rounded-md"></select>
                <select id="day-modal-action-select" class="w-full rounded-md">
                    <option value="none">Sin preferencia</option>
                    <option value="assign">ASIGNAR GUARDIA (Obligatorio)</option>
                    <option value="preferred">Preferido (Sí Guardia)</option>
                    <option value="avoid">Evitar (No Guardia)</option>
                    <option value="blocked">BLOQUEAR</option>
                </select>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button id="day-modal-close-btn" class="bg-gray-200 px-3 py-1 rounded text-sm">Cerrar</button>
                <button id="day-modal-save-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Aplicar</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast-notification"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CORRECT_PASSWORD = "Notti2603";
        const MIN_REST_DAYS = 2;

        let state = { 
            residents: [], 
            groups: [], 
            holidays: [], 
            logo: null,
            daySlots: {},
            previousMonthShifts: { lastDay: [], secondLastDay: [] },
            dragSwaps: [],
            highlights: {},
            lastInvalidSwap: null,
            filteredResidents: [],
            targetShifts: { weekday: 4, weekend: 2 }
        };
        let currentSchedule = null;
        let currentDayModalDay = null;

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const monthSelect = document.getElementById('month-select');
        const yearInput = document.getElementById('year-input');
        const generateBtn = document.getElementById('generate-btn');
        const holidaysInput = document.getElementById('holidays-input');
        const secondLastDayShiftsInput = document.getElementById('second-last-day-shifts');
        const lastDayShiftsInput = document.getElementById('last-day-shifts');
        const targetWeekdayShiftsInput = document.getElementById('target-weekday-shifts');
        const targetWeekendShiftsInput = document.getElementById('target-weekend-shifts');
        const slotsCalendarGrid = document.getElementById('slots-calendar-grid');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarTitle = document.getElementById('calendar-title');
        const validationList = document.getElementById('validation-list');
        const residentQuickFilter = document.getElementById('resident-quick-filter');
        const exportIcalBtn = document.getElementById('export-ical-btn');
        const criteriaSummaryList = document.getElementById('criteria-summary-list');
        const summaryGrid = document.getElementById('summary-grid');
        const groupNameInput = document.getElementById('group-name');
        const groupMembersChecklist = document.getElementById('group-members-checklist');
        const createGroupBtn = document.getElementById('create-group-btn');
        const groupsDisplay = document.getElementById('groups-display');
        const addResidentForm = document.getElementById('add-resident-form');
        const newResidentNameInput = document.getElementById('new-resident-name');
        const residentList = document.getElementById('resident-list');
        const exportPngBtn = document.getElementById('export-png-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const includeSummaryPdf = document.getElementById('include-summary-pdf');
        const exportConfigBtn = document.getElementById('export-config-btn');
        const importConfigInput = document.getElementById('import-config-input');
        const toast = document.getElementById('toast');
        const prefModal = document.getElementById('preferences-modal');
        const modalResidentName = document.getElementById('modal-resident-name');
        const modalResidentId = document.getElementById('modal-resident-id');
        const residentStatusSelect = document.getElementById('resident-status');
        const individualTargetWeekdayInput = document.getElementById('individual-target-weekday');
        const individualTargetWeekendInput = document.getElementById('individual-target-weekend');
        const equityContainer = document.getElementById('equity-container');
        const saturdayCountInput = document.getElementById('saturday-count');
        const sundayCountInput = document.getElementById('sunday-count');
        const holidayCountInput = document.getElementById('holiday-count');
        const manualAssignmentsInput = document.getElementById('manual-assignments-input');
        const daysPreferenceSection = document.getElementById('days-preference-section');
        const preferredDaysInput = document.getElementById('preferred-days');
        const avoidDaysInput = document.getElementById('avoid-days');
        const blockedDaysInput = document.getElementById('blocked-days');
        const avoidResidentsChecklist = document.getElementById('avoid-residents-checklist');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const dayModal = document.getElementById('day-modal');
        const dayModalTitle = document.getElementById('day-modal-title');
        const dayModalResidentSelect = document.getElementById('day-modal-resident-select');
        const dayModalActionSelect = document.getElementById('day-modal-action-select');
        const dayModalSaveBtn = document.getElementById('day-modal-save-btn');
        const dayModalCloseBtn = document.getElementById('day-modal-close-btn');
        // NUEVO: Contadores de cupos
        const weekdaySlotCountEl = document.getElementById('weekday-slot-count');
        const weekendSlotCountEl = document.getElementById('weekend-slot-count');


        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function saveState() {
            localStorage.setItem('residentSchedulerState_v11_dnd', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('residentSchedulerState_v11_dnd');
            if (savedState) {
                const loaded = JSON.parse(savedState);
                loaded.filteredResidents = [];
                if (!loaded.dragSwaps) loaded.dragSwaps = [];
                if (!loaded.highlights) loaded.highlights = {};
                if (!loaded.lastInvalidSwap) loaded.lastInvalidSwap = null;
                
                if (!loaded.targetShifts) {
                    loaded.targetShifts = { weekday: 4, weekend: 2 };
                }
                if(loaded.residents) {
                    loaded.residents.forEach(r => {
                        if(!r.targetShifts) {
                            r.targetShifts = { weekday: null, weekend: null };
                        }
                    });
                }
                Object.assign(state, loaded);
            } else {
                // Fallback state if nothing is in localStorage
                state.residents = ["Luchi", "Fer", "Regi", "Agos", "Cami", "Agus", "Clara", "Mati", "Celmi", "Sabri", "Tati", "Jessi", "Ro", "Vale G", "Lule", "Coti", "Santi", "Dai", "Mile"].map((name, i) => ({
                    id: i, name, status: 'active',
                    preferences: { preferred: [], avoid: [] },
                    blocked: [], avoidResidents: [],
                    equity: { saturdays: 0, sundays: 0, holidays: 0 },
                    manualAssignments: [],
                    targetShifts: { weekday: null, weekend: null }
                }));
            }
        }

        function init() {
            loadState();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthSelect.innerHTML = monthNames.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            
            // Establecer el mes de Noviembre (índice 10) por defecto
            const defaultMonth = 10;
            const defaultYear = 2025;
            monthSelect.value = defaultMonth;
            yearInput.value = defaultYear;
            
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('active');
                    const content = header.nextElementSibling;
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
            refreshUIFromState();
        }

        function refreshUIFromState() {
            holidaysInput.value = state.holidays.join(', ');
            targetWeekdayShiftsInput.value = state.targetShifts.weekday;
            targetWeekendShiftsInput.value = state.targetShifts.weekend;
            updatePreviousMonthInputs();
            renderResidentList();
            renderGroupChecklist();
            renderGroupsList();
            renderSlotsCalendar();
            renderQuickFilter();
            updateSlotCounters(); // NUEVO: Actualizar contadores al cargar
            generateAndDisplaySchedule();
        }

        function updatePreviousMonthInputs() {
            const year = parseInt(yearInput.value);
            const month = parseInt(monthSelect.value);
            const prevMonthDate = new Date(year, month, 0);
            const lastDay = prevMonthDate.getDate();
            const secondLastDay = lastDay - 1;
            prevMonthDate.setDate(1);
            const prevMonthName = prevMonthDate.toLocaleString('es-ES', { month: 'long' });

            document.getElementById('last-day-label').textContent = `Guardias del ${lastDay} de ${prevMonthName}`;
            document.getElementById('second-last-day-label').textContent = `Guardias del ${secondLastDay} de ${prevMonthName}`;
            
            lastDayShiftsInput.value = state.previousMonthShifts.lastDay.join(', ');
            secondLastDayShiftsInput.value = state.previousMonthShifts.secondLastDay.join(', ');
        }

        function generateAndDisplaySchedule() {
            state.highlights = {};
            state.lastInvalidSwap = null;
            state.dragSwaps = [];
            const year = parseInt(yearInput.value);
            const month = parseInt(monthSelect.value);
            state.holidays = holidaysInput.value.split(',').map(s => parseInt(s.trim())).filter(Boolean);
            state.previousMonthShifts.lastDay = lastDayShiftsInput.value.split(',').map(s => s.trim()).filter(Boolean);
            state.previousMonthShifts.secondLastDay = secondLastDayShiftsInput.value.split(',').map(s => s.trim()).filter(Boolean);
            saveState();
            
            updateSlotCounters(); // NUEVO: Actualizar contadores antes de generar
            calendarTitle.textContent = `Cronograma para ${monthSelect.options[month].text} de ${year}`;
            const result = generateSchedule(year, month);
            currentSchedule = result; 
            
            if (result.error) {
                calendarGrid.innerHTML = `<div class="col-span-7 text-center p-8 text-red-600 bg-red-100 rounded-lg"><strong>Error:</strong> ${result.error}</div>`;
                renderSummary([]);
                validationList.innerHTML = '';
            } else {
                renderCalendar(result.schedule, year, month);
                recalculateStatsAndUpdateUI(result.schedule);
            }
            renderDragSwapsHistory();
        }
        
        function generateSchedule(year, month) {
            const residents = JSON.parse(JSON.stringify(state.residents.filter(r => r.status === 'active')));
            residents.forEach(r => { 
                r.shifts = []; r.weekendCount = 0; r.weekdayCount = 0; r.lastShiftDay = -100;
                if(state.previousMonthShifts.lastDay.includes(r.name)) r.lastShiftDay = 0;
                if(state.previousMonthShifts.secondLastDay.includes(r.name)) r.lastShiftDay = -1;
            });

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthKey = `${year}-${month}`;
            const monthSlots = state.daySlots[monthKey] || {};
            
            const slots = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6 || state.holidays.includes(day);
                const slotCount = monthSlots[day] || 0;
                for (let i = 0; i < slotCount; i++) {
                    slots.push({ day, type: isWeekend ? 'weekend' : 'weekday', resident: null });
                }
            }

            // Asignaciones Manuales
            for (const res of residents) {
                for (const day of res.manualAssignments) {
                    if (res.lastShiftDay > day - (MIN_REST_DAYS + 1)) {
                         return { error: `Conflicto de descanso para ${res.name} en su asignación manual del día ${day}.` };
                    }
                    const slotToFill = slots.find(s => s.day === day && !s.resident);
                    if (!slotToFill) {
                        return { error: `No hay cupos libres el día ${day} para la asignación manual de ${res.name}.` };
                    }
                    slotToFill.resident = res;
                    res.shifts.push({ day: slotToFill.day, type: slotToFill.type });
                    res.lastShiftDay = slotToFill.day;
                    if (slotToFill.type === 'weekend') res.weekendCount++; else res.weekdayCount++;
                }
            }

            // Asignación principal
            for (const slot of slots.filter(s => !s.resident)) {
                const bestResident = findBestResident(slot, residents, slots, year, month);
                if (!bestResident) {
                    return { error: `No se pudo encontrar un residente disponible para el día ${slot.day}. Revisa los bloqueos y descansos.` };
                }
                slot.resident = bestResident;
                bestResident.shifts.push({ day: slot.day, type: slot.type });
                bestResident.lastShiftDay = slot.day;
                if (slot.type === 'weekend') bestResident.weekendCount++; else bestResident.weekdayCount++;
            }

            const scheduleByDay = {};
            for (let day = 1; day <= daysInMonth; day++) scheduleByDay[day] = [];
            slots.forEach(slot => {
                if(slot.resident) scheduleByDay[slot.day].push(slot.resident.name)
            });
            return { schedule: scheduleByDay, stats: residents };
        }

        function findBestResident(slot, residents, allSlots, year, month) {
            let candidates = residents.filter(res => {
                const hasRested = slot.day > res.lastShiftDay + MIN_REST_DAYS;
                const isBlocked = res.blocked.includes(slot.day);
                const isManuallyAssigned = res.manualAssignments.includes(slot.day);
                return hasRested && !isBlocked && !isManuallyAssigned;
            });

            if (candidates.length === 0) return null;

            const residentsOnSameDay = allSlots.filter(s => s.day === slot.day && s.resident).map(s => s.resident.id);

            candidates.forEach(res => {
                let score = 0;
                const residentData = state.residents.find(r => r.id === res.id);
                
                // Prioridad 1: Balance total de guardias
                const targetWeekday = residentData.targetShifts.weekday ?? state.targetShifts.weekday;
                const targetWeekend = residentData.targetShifts.weekend ?? state.targetShifts.weekend;
                
                /* ********************************************************** */
                /* LÓGICA DE PUNTUACIÓN REESCRITA (2025-10-30)                */
                /* Se reemplaza la lógica de "escalón" (>= target) por       */
                /* una penalización proporcional que balancea mejor.         */
                /* ********************************************************** */

                // Prioridad 1: Penalización por total de guardias (la más alta)
                // Esto asegura el balance 6-6-6-7 en lugar de 5-7.
                score -= res.shifts.length * 100000;

                // Prioridad 2: Penalización por tipo de guardia (Finde/Feriado)
                // Penalización muy alta para evitar desbalance de findes.
                if (slot.type === 'weekend') {
                    score -= res.weekendCount * 50000;
                }

                // Prioridad 3: Penalización por tipo de guardia (Semana)
                // Penalización media para balancear los días de semana.
                if (slot.type === 'weekday') {
                    score -= res.weekdayCount * 10000;
                }
                
                /* --- FIN DE LA LÓGICA REESCRITA --- */


                // *** CAMBIO REALIZADO ***
                // Penalización Fuerte por exceso de finde/feriado
                /* ELIMINADO: Reemplazado por la lógica proporcional de arriba
                if (slot.type === 'weekend' && res.weekendCount >= targetWeekend) {
                    score -= 200000; 
                }
                */
                
                // *** CAMBIO REALIZADO ***
                // Prioridad 3: Descanso (más días desde la última guardia es mejor)
                score += (slot.day - res.lastShiftDay) * 100; // MODIFICADO: Reducida la bonificación para que no supere al balance
                
                // Prioridad 4: Preferencias y Grupos
                if (res.preferences.preferred.includes(slot.day)) score += 500;
                if (res.preferences.avoid.includes(slot.day)) score -= 500;
                
                state.groups.forEach(group => {
                    if (group.members.includes(res.id) && group.members.some(id => residentsOnSameDay.includes(id))) {
                        score += 10000; // Bonus de grupo
                    }
                });

                if (residentsOnSameDay.some(id => res.avoidResidents.includes(id)) || residentsOnSameDay.some(id => state.residents.find(r=>r.id===id).avoidResidents.includes(res.id))) {
                    score -= 10000; // Penalización de evitación
                }
                
                // Prioridad 5: Equidad de findes/feriados (más baja)
                const date = new Date(year, month, slot.day);
                const dayOfWeek = date.getDay();
                if (state.holidays.includes(slot.day)) score -= res.equity.holidays * 50;
                else if (dayOfWeek === 6) score -= res.equity.saturdays * 50;
                else if (dayOfWeek === 0) score -= res.equity.sundays * 50;

                res.score = score;
            });

            return candidates.sort((a, b) => b.score - a.score)[0];
        }
        
        // Validación de Balance
        function runBalanceValidations(stats) {
            const activeStats = stats.filter(s => state.residents.find(r => r.id === s.id)?.status === 'active');
            if (activeStats.length === 0) return;

            // 1. Chequear balance de guardias totales
            const totalShifts = activeStats.map(s => s.weekdayCount + s.weekendCount);
            const minShifts = Math.min(...totalShifts);
            const maxShifts = Math.max(...totalShifts);
            const totalBalanceError = maxShifts - minShifts > 1;
            
            validationList.innerHTML += `<div class="flex items-center">${!totalBalanceError ? '<span class="text-green-500 mr-2">✔️</span>' : '<span class="text-red-500 mr-2">❌</span>'} Balance total de guardias equitativo (Max ${maxShifts}, Min ${minShifts}). ${totalBalanceError ? `<span class="text-red-500 text-xs ml-2">(Diferencia mayor a 1)</span>` : ''}</div>`;

            // 2. Chequear balance de findes/feriados
            let weekendErrors = [];
            const defaultTargetWeekend = state.targetShifts.weekend;
            activeStats.forEach(res => {
                const residentData = state.residents.find(r => r.id === res.id);
                const targetWeekend = residentData?.targetShifts.weekend ?? defaultTargetWeekend;
                if (res.weekendCount > targetWeekend) {
                    weekendErrors.push(`${res.name} (${res.weekendCount})`);
                }
            });
            
            const minWeekendShifts = Math.min(...activeStats.map(s => s.weekendCount));
            // El error de mínimo solo se muestra si el *máximo* no supera el objetivo.
            // Si el max es 3, es normal que el min sea 2 (ej. 34 cupos).
            // Pero si el max es 2, el min no debería ser 1.
            const maxWeekendShifts = Math.max(...activeStats.map(s => s.weekendCount));
            const weekendMinError = minWeekendShifts < defaultTargetWeekend && maxWeekendShifts <= defaultTargetWeekend;


            validationList.innerHTML += `<div class="flex items-center">${(weekendErrors.length === 0 && !weekendMinError) ? '<span class="text-green-500 mr-2">✔️</span>' : '<span class="text-red-500 mr-2">❌</span>'} Balance de findes/feriados equitativo. ${weekendErrors.length > 0 ? `<span class="text-red-500 text-xs ml-2">(Excesos: ${weekendErrors.join(', ')})</span>` : ''} ${weekendMinError ? `<span class="text-red-500 text-xs ml-2">(Mínimo ${minWeekendShifts})</span>` : ''}</div>`;
        }

        function runValidations(schedule, stats) {
            validationList.innerHTML = '';
            let sandwichErrors = [];
            let mandatoryErrors = [];

            stats.forEach(res => {
                const shifts = res.shifts.map(s => s.day).sort((a, b) => a - b);
                for (let i = 0; i < shifts.length - 1; i++) {
                    if (shifts[i+1] - shifts[i] <= MIN_REST_DAYS) {
                        sandwichErrors.push(`${res.name} (días ${shifts[i]} y ${shifts[i+1]})`);
                    }
                }
                
                const resData = state.residents.find(r => r.id === res.id);
                if(resData) {
                    resData.manualAssignments.forEach(day => {
                        if (!shifts.includes(day)) mandatoryErrors.push(`Asignación de ${res.name} el día ${day} no cumplida.`);
                    });
                    resData.blocked.forEach(day => {
                        if (shifts.includes(day)) mandatoryErrors.push(`Bloqueo de ${res.name} el día ${day} no cumplido.`);
                    });
                }
            });

            validationList.innerHTML += `<div class="flex items-center">${sandwichErrors.length === 0 ? '<span class="text-green-500 mr-2">✔️</span>' : '<span class="text-red-500 mr-2">❌</span>'} Sin Guardia Sándwich. ${sandwichErrors.length > 0 ? `<span class="text-red-500 text-xs ml-2">(${sandwichErrors.join(', ')})</span>` : ''}</div>`;
            validationList.innerHTML += `<div class="flex items-center">${mandatoryErrors.length === 0 ? '<span class="text-green-500 mr-2">✔️</span>' : '<span class="text-red-500 mr-2">❌</span>'} Criterios obligatorios cumplidos. ${mandatoryErrors.length > 0 ? `<span class="text-red-500 text-xs ml-2">(${mandatoryErrors.join(', ')})</span>` : ''}</div>`;
            
            runBalanceValidations(stats);
        }

        // --- Renderizado y UI ---
        function renderSlotsCalendar() {
            slotsCalendarGrid.innerHTML = '';
            const year = parseInt(yearInput.value);
            const month = parseInt(monthSelect.value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const startingDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            const monthKey = `${year}-${month}`;
            if (!state.daySlots[monthKey]) state.daySlots[monthKey] = {};
            
            ['L', 'M', 'M', 'J', 'V', 'S', 'D'].forEach(day => {
                slotsCalendarGrid.innerHTML += `<div class="header-day font-bold text-center p-2 rounded">${day}</div>`;
            });
            for (let i = 0; i < startingDay; i++) slotsCalendarGrid.innerHTML += '<div></div>';
            for (let day = 1; day <= daysInMonth; day++) {
                const slotCount = state.daySlots[monthKey][day] || 0;
                slotsCalendarGrid.innerHTML += `
                    <div class="border rounded p-2 text-center">
                        <div class="font-bold text-sm">${day}</div>
                        <input type="number" value="${slotCount}" min="0" class="slot-input" data-day="${day}">
                    </div>`;
            }
        }
        
        function renderCalendar(schedule, year, month) {
            calendarGrid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            ['L', 'M', 'M', 'J', 'V', 'S', 'D'].forEach(day => {
                calendarGrid.innerHTML += `<div class="header-day font-bold text-center p-1 sm:p-2 rounded">${day}</div>`;
            });
            for (let i = 0; i < startingDay; i++) calendarGrid.innerHTML += '<div></div>';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                let classes = 'border rounded-lg p-1 sm:p-2 min-h-[80px] sm:min-h-[120px] flex flex-col';
                if (state.holidays.includes(day)) classes += ' holiday-day';
                else if (dayOfWeek === 0 || dayOfWeek === 6) classes += ' weekend-day';
                
                const dayCell = document.createElement('div');
                dayCell.className = classes;
                dayCell.dataset.day = day;
                const residentsOnDay = (schedule[day] || []).map(name => {
                    const isFiltered = state.filteredResidents.length > 0 && !state.filteredResidents.includes(name);
                    let liClass = 'resident-chip';
                    let content = `<span>${name}</span>`;

                    const dayHighlights = state.highlights[day] || [];
                    const highlight = dayHighlights.find(h => h.residentName === name);

                    if (highlight) {
                        if (highlight.type === 'duplicate') {
                            liClass += ' duplicate-shift';
                            content = `<div class="resident-chip-container"><span>${name}</span><span class="revert-btn" title="Revertir último cambio inválido">×</span></div>`;
                        } else if (highlight.type === 'sandwich') {
                            liClass += ' sandwich-shift';
                        } else if (highlight.type === 'success') {
                            liClass += ' successful-swap';
                        }
                    } else {
                        liClass += ' bg-blue-100 text-blue-800'; // Default
                    }
                    
                    if (isFiltered) liClass += ' filtered-out';
                    
                    return `<li class="${liClass}" draggable="true" data-resident-name="${name}" data-day="${day}">${content}</li>`;
                }).join('');
                dayCell.innerHTML = `<div class="font-bold text-sm cursor-pointer hover:text-blue-600">${day}</div><ul class="text-xs mt-1 space-y-1">${residentsOnDay}</ul>`;
                dayCell.querySelector('div.font-bold').addEventListener('click', () => openDayModal(day));
                calendarGrid.appendChild(dayCell);
            }
        }

        function renderSummary(stats) {
            summaryGrid.innerHTML = '';
            const allResidents = JSON.parse(JSON.stringify(state.residents));
            allResidents.forEach(res => {
                const statData = stats.find(s => s.id === res.id);
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg shadow ${res.status === 'on_leave' ? 'bg-gray-200 opacity-70' : 'bg-white'}`;
                let content = `<p class="font-semibold text-blue-700 cursor-pointer hover:underline" data-id="${res.id}">${res.name}</p>`;
                if (res.status === 'on_leave') {
                    content += `<p class="text-sm font-bold text-gray-600 mt-2">De Licencia</p>`;
                } else {
                    const weekdayCount = statData ? statData.weekdayCount : 0;
                    const weekendCount = statData ? statData.weekendCount : 0;
                    content += `<p class="text-sm text-gray-600">Semana: <b>${weekdayCount}</b> | Finde/Feriado: <b>${weekendCount}</b> | Total: <b>${weekdayCount + weekendCount}</b></p>`;
                }
                card.innerHTML = content;
                card.querySelector('p[data-id]').addEventListener('click', () => openPreferencesModal(res.id));
                summaryGrid.appendChild(card);
            });
        }
        
        function renderCriteriaSummary() {
            criteriaSummaryList.innerHTML = '';
            if (!currentSchedule || currentSchedule.error) return;
            const residentsWithCriteria = state.residents.filter(r => 
                r.status === 'on_leave' || 
                r.blocked.length > 0 || 
                r.manualAssignments.length > 0 || 
                r.preferences.preferred.length > 0 || 
                r.preferences.avoid.length > 0 ||
                (r.targetShifts && (r.targetShifts.weekday !== null || r.targetShifts.weekend !== null))
            );

            if (residentsWithCriteria.length === 0) {
                criteriaSummaryList.innerHTML = '<p class="text-gray-500 col-span-full">No hay criterios individuales definidos para este mes.</p>';
                return;
            }

            residentsWithCriteria.forEach(res => {
                let criteriaHtml = `<div class="border rounded-lg p-3 bg-gray-50"><p class="font-bold text-gray-800">${res.name}</p><div class="mt-1 space-y-1">`;
                if (res.status === 'on_leave') criteriaHtml += `<p class="text-gray-600 font-semibold">De Licencia</p>`;
                
                const resStats = currentSchedule.stats.find(s => s.id === res.id);
                const actualShifts = resStats ? resStats.shifts.map(s => s.day) : [];

                if (res.targetShifts && (res.targetShifts.weekday !== null || res.targetShifts.weekend !== null)) {
                    const weekdayTarget = res.targetShifts.weekday ?? 'D';
                    const weekendTarget = res.targetShifts.weekend ?? 'D';
                    criteriaHtml += `<p><span class="font-semibold text-purple-600">Objetivo:</span> ${weekdayTarget} sem, ${weekendTarget} fin</p>`;
                }
                if (res.manualAssignments.length > 0) criteriaHtml += `<p><span class="font-semibold text-green-600">Asignado:</span> Días ${res.manualAssignments.map(d => `<span class="font-bold text-green-600">${d}</span>`).join(', ')}</p>`;
                if (res.blocked.length > 0) criteriaHtml += `<p><span class="font-semibold text-red-600">Bloqueado:</span> Días ${res.blocked.map(d => `<span class="font-bold text-red-600">${d}</span>`).join(', ')}</p>`;
                if (res.preferences.preferred.length > 0) {
                    const formattedDays = res.preferences.preferred.map(day => {
                        const color = actualShifts.includes(day) ? 'text-green-600' : 'text-red-600';
                        return `<span class="font-bold ${color}">${day}</span>`;
                    }).join(', ');
                    criteriaHtml += `<p><span class="font-semibold text-blue-600">Prefiere:</span> Días ${formattedDays}</p>`;
                }
                if (res.preferences.avoid.length > 0) {
                     const formattedDays = res.preferences.avoid.map(day => {
                        const color = !actualShifts.includes(day) ? 'text-green-600' : 'text-red-600';
                        return `<span class="font-bold ${color}">${day}</span>`;
                    }).join(', ');
                    criteriaHtml += `<p><span class="font-semibold text-orange-600">Evita:</span> Días ${formattedDays}</p>`;
                }
                criteriaHtml += '</div></div>';
                criteriaSummaryList.innerHTML += criteriaHtml;
            });
        }

        function renderGroupChecklist() {
            groupMembersChecklist.innerHTML = state.residents.map(res => `
                <div class="flex items-center">
                    <input type="checkbox" id="res-check-${res.id}" value="${res.id}" class="h-4 w-4 rounded">
                    <label for="res-check-${res.id}" class="ml-2 block text-sm">${res.name}</label>
                </div>`).join('');
        }

        function renderGroupsList() {
            groupsDisplay.innerHTML = state.groups.length === 0 
                ? '<p class="text-sm text-gray-500">No hay grupos.</p>'
                : state.groups.map((group, index) => `
                    <div class="p-2 border rounded-md bg-gray-50">
                        <p class="font-bold text-sm">${group.name}</p>
                        <p class="text-xs">${group.members.map(id => state.residents.find(r=>r.id===id)?.name || 'N/A').join(', ')}</p>
                        <button data-index="${index}" class="text-xs text-red-500 hover:underline mt-1 delete-group-btn">Eliminar</button>
                    </div>`).join('');
        }
        
        function renderQuickFilter() {
            residentQuickFilter.innerHTML = '';
            state.residents.forEach(res => {
                const isActive = state.filteredResidents.includes(res.name);
                const filterChip = document.createElement('button');
                filterChip.textContent = res.name;
                filterChip.dataset.residentName = res.name;
                filterChip.className = `px-3 py-1 text-xs font-medium rounded-full cursor-pointer transition-colors ${isActive ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                residentQuickFilter.appendChild(filterChip);
            });
        }
        
        function renderResidentList() {
            residentList.innerHTML = state.residents.map(res => `
                <div class="flex justify-between items-center p-1 bg-gray-100 rounded">
                    <span>${res.name}</span>
                    <button data-id="${res.id}" class="text-red-500 font-bold px-2 delete-resident-btn">X</button>
                </div>
            `).join('');
        }

        function openPreferencesModal(residentId) {
            const res = state.residents.find(r => r.id === residentId);
            modalResidentName.textContent = `Preferencias de ${res.name}`;
            modalResidentId.value = res.id;
            residentStatusSelect.value = res.status;

            individualTargetWeekdayInput.value = res.targetShifts.weekday ?? '';
            individualTargetWeekendInput.value = res.targetShifts.weekend ?? '';

            saturdayCountInput.value = res.equity.saturdays;
            sundayCountInput.value = res.equity.sundays;
            holidayCountInput.value = res.equity.holidays;
            preferredDaysInput.value = res.preferences.preferred.join(', ');
            avoidDaysInput.value = res.preferences.avoid.join(', ');
            blockedDaysInput.value = res.blocked.join(', ');
            manualAssignmentsInput.value = res.manualAssignments.join(', ');
            avoidResidentsChecklist.innerHTML = state.residents.filter(r => r.id !== res.id).map(other => `
                <div class="flex items-center">
                    <input type="checkbox" id="avoid-res-${other.id}" value="${other.id}" ${res.avoidResidents.includes(other.id) ? 'checked' : ''} class="h-4 w-4 rounded">
                    <label for="avoid-res-${other.id}" class="ml-2 text-sm">${other.name}</label>
                </div>`).join('');
            toggleModalSections(res.status);
            prefModal.style.display = 'flex';
        }

        function savePreferences() {
            const resId = parseInt(modalResidentId.value);
            const res = state.residents.find(r => r.id === resId);
            const parseDays = (input) => input.value.split(',').map(s => parseInt(s.trim())).filter(Boolean);
            
            const targetWeekday = individualTargetWeekdayInput.value;
            const targetWeekend = individualTargetWeekendInput.value;
            res.targetShifts.weekday = targetWeekday === '' ? null : parseInt(targetWeekday);
            res.targetShifts.weekend = targetWeekend === '' ? null : parseInt(targetWeekend);

            res.status = residentStatusSelect.value;
            res.equity = { saturdays: parseInt(saturdayCountInput.value), sundays: parseInt(sundayCountInput.value), holidays: parseInt(holidayCountInput.value) };
            res.preferences = { preferred: parseDays(preferredDaysInput), avoid: parseDays(avoidDaysInput) };
            res.blocked = parseDays(blockedDaysInput);
            res.manualAssignments = parseDays(manualAssignmentsInput);
            res.avoidResidents = Array.from(avoidResidentsChecklist.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
            saveState();
            recalculateStatsAndUpdateUI(currentSchedule.schedule);
            prefModal.style.display = 'none';
            showToast(`Preferencias de ${res.name} guardadas.`);
        }

        function toggleModalSections(status) {
            const show = (el) => el.style.display = 'block';
            const hide = (el) => el.style.display = 'none';
            const targetShiftsContainer = document.getElementById('target-shifts-container');
            if (status === 'on_leave') {
                hide(equityContainer); 
                hide(daysPreferenceSection); 
                hide(document.getElementById('avoid-residents-section'));
                hide(targetShiftsContainer);
            } else {
                show(equityContainer); 
                show(daysPreferenceSection); 
                show(document.getElementById('avoid-residents-section'));
                show(targetShiftsContainer);
            }
        }
        
        function openDayModal(day) {
            currentDayModalDay = day;
            dayModalTitle.textContent = `Preferencias para el Día ${day}`;
            dayModalResidentSelect.innerHTML = state.residents.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            dayModal.style.display = 'flex';
        }

        function saveDayPreference() {
            const resId = parseInt(dayModalResidentSelect.value);
            const action = dayModalActionSelect.value;
            const res = state.residents.find(r => r.id === resId);
            
            ['preferred', 'avoid'].forEach(key => res.preferences[key] = res.preferences[key].filter(d => d !== currentDayModalDay));
            res.blocked = res.blocked.filter(d => d !== currentDayModalDay);
            res.manualAssignments = res.manualAssignments.filter(d => d !== currentDayModalDay);

            if (action === 'assign') res.manualAssignments.push(currentDayModalDay);
            else if (action === 'preferred') res.preferences.preferred.push(currentDayModalDay);
            else if (action === 'avoid') res.preferences.avoid.push(currentDayModalDay);
            else if (action === 'blocked') res.blocked.push(currentDayModalDay);

            saveState();
            recalculateStatsAndUpdateUI(currentSchedule.schedule);
            showToast(`Preferencia para ${res.name} el día ${currentDayModalDay} guardada.`);
            dayModal.style.display = 'none';
        }
        
        function renderDragSwapsHistory() {
            const list = document.getElementById('drag-swaps-list');
            if (list) {
                if (state.dragSwaps && state.dragSwaps.length > 0) {
                    list.innerHTML = state.dragSwaps.map(swap => {
                        let statusClass = '';
                        if (swap.status === 'success') {
                            statusClass = 'successful-swap';
                        } else if (swap.status === 'sandwich') {
                            statusClass = 'sandwich-shift';
                        }
                        return `
                            <div class="text-xs p-1 rounded ${statusClass}">
                                <span>Intercambio: <b>${swap.res1Name}</b> (día ${swap.res1Day}) con <b>${swap.res2Name}</b> (día ${swap.res2Day})</span>
                            </div>`;
                    }).join('');
                } else {
                    list.innerHTML = '<p class="text-xs text-gray-500">No se han realizado cambios.</p>';
                }
            }
        }
        
        function recalculateStatsAndUpdateUI(schedule, shouldRender = true) {
            const newStats = JSON.parse(JSON.stringify(state.residents.filter(r => r.status === 'active')));
            newStats.forEach(r => { r.shifts = []; r.weekdayCount = 0; r.weekendCount = 0; });
            for (const day in schedule) {
                const date = new Date(yearInput.value, monthSelect.value, day);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6 || state.holidays.includes(parseInt(day));
                schedule[day].forEach(name => {
                    const res = newStats.find(r => r.name === name);
                    if (res) {
                        const shift = { day: parseInt(day), type: isWeekend ? 'weekend' : 'weekday' };
                        res.shifts.push(shift);
                        if (isWeekend) res.weekendCount++; else res.weekdayCount++;
                    }
                });
            }
            currentSchedule.stats = newStats;
            if(shouldRender){
                renderSummary(newStats);
                runValidations(schedule, newStats);
                renderCriteriaSummary();
            }
        }

        function addHighlight(day, residentName, type) {
            if (!state.highlights[day]) state.highlights[day] = [];
            state.highlights[day].push({ residentName, type });
        }

        // --- NUEVA FUNCIÓN CONTADOR DE CUPOS ---
        function updateSlotCounters() {
            let weekdayTotal = 0;
            let weekendTotal = 0;
            const year = parseInt(yearInput.value);
            const month = parseInt(monthSelect.value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthKey = `${year}-${month}`;
            const monthSlots = state.daySlots[monthKey] || {};
            const currentHolidays = holidaysInput.value.split(',').map(s => parseInt(s.trim())).filter(Boolean);

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6 || currentHolidays.includes(day);
                const slotCount = monthSlots[day] || 0;
                
                if (isWeekend) {
                    weekendTotal += slotCount;
                } else {
                    weekdayTotal += slotCount;
                }
            }

            weekdaySlotCountEl.textContent = weekdayTotal;
            weekendSlotCountEl.textContent = weekendTotal;
        }

        function validateSwap(sourceResName, sourceDay, targetResName, targetDay) {
            state.highlights = {};
            state.lastInvalidSwap = null;
            let isSandwich = false;
            const schedule = currentSchedule.schedule;

            // 1. Check for duplicates (critical error)
            if (schedule[sourceDay].filter(r => r === targetResName).length > 1 || schedule[targetDay].filter(r => r === sourceResName).length > 1) {
                if (schedule[sourceDay].filter(r => r === targetResName).length > 1) addHighlight(sourceDay, targetResName, 'duplicate');
                if (schedule[targetDay].filter(r => r === sourceResName).length > 1) addHighlight(targetDay, sourceResName, 'duplicate');
                
                state.lastInvalidSwap = { res1Name: sourceResName, res1Day: sourceDay, res2Name: targetResName, res2Day: targetDay };
                showToast('Error: Un residente no puede estar dos veces el mismo día.', true);
                return 'duplicate';
            }

            // 2. Check for sandwich shifts (warning)
            const residentsToCheck = [sourceResName, targetResName];
            residentsToCheck.forEach(resName => {
                const resShifts = currentSchedule.stats.find(r => r.name === resName)?.shifts.map(s => s.day).sort((a,b)=>a-b);
                if (!resShifts) return;

                for (let i = 0; i < resShifts.length - 1; i++) {
                    if (resShifts[i+1] - resShifts[i] <= MIN_REST_DAYS) {
                        isSandwich = true;
                        addHighlight(resShifts[i], resName, 'sandwich');
                        addHighlight(resShifts[i+1], resName, 'sandwich');
                    }
                }
            });

            if(isSandwich) {
                showToast('Advertencia: El cambio genera una guardia sándwich.', true);
                return 'sandwich';
            } 
            
            // 3. If no errors, it's a success
            addHighlight(sourceDay, targetResName, 'success');
            addHighlight(targetDay, sourceResName, 'success');
            return 'success';
        }
        function handleICalExport() {
            if (!currentSchedule || currentSchedule.error) {
                showToast('Genera un cronograma válido antes de exportar.', true);
                return;
            }
            if (state.filteredResidents.length === 0) {
                showToast('Selecciona al menos un residente para exportar.', true);
                return;
            }
            const year = parseInt(yearInput.value);
            const month = parseInt(monthSelect.value);
            state.filteredResidents.forEach(residentName => {
                const residentStats = currentSchedule.stats.find(r => r.name === residentName);
                if (!residentStats || residentStats.shifts.length === 0) return;
                let icalContent = [ 'BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//NottiScheduler//EN' ];
                residentStats.shifts.forEach(shift => {
                    const startDate = new Date(year, month, shift.day);
                    const endDate = new Date(year, month, shift.day + 1);
                    const formatICalDate = (date) => date.toISOString().split('T')[0].replace(/-/g, '');
                    icalContent.push(
                        'BEGIN:VEVENT', `UID:${year}${month}${shift.day}${residentName}@nottischeduler`,
                        `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                        `DTSTART;VALUE=DATE:${formatICalDate(startDate)}`,
                        `DTEND;VALUE=DATE:${formatICalDate(endDate)}`,
                        'SUMMARY:Guardia Hospital Notti', 'END:VEVENT'
                    );
                });
                icalContent.push('END:VCALENDAR');
                const blob = new Blob([icalContent.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `cronograma-${residentName.replace(/\s/g, '_')}.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            showToast(`Exportando ${state.filteredResidents.length} calendario(s)...`);
        }
        
        function handleExportConfig() {
            // Corrección: Lee los valores de la UI antes de exportar
            try {
                state.holidays = holidaysInput.value.split(',').map(s => parseInt(s.trim())).filter(Boolean);
                state.previousMonthShifts.lastDay = lastDayShiftsInput.value.split(',').map(s => s.trim()).filter(Boolean);
                state.previousMonthShifts.secondLastDay = secondLastDayShiftsInput.value.split(',').map(s => s.trim()).filter(Boolean);
            } catch (e) {
                console.error("Error al leer los campos de la UI durante la exportación:", e);
            }

            const configToExport = {
                residents: state.residents,
                groups: state.groups,
                holidays: state.holidays, 
                daySlots: state.daySlots,
                previousMonthShifts: state.previousMonthShifts, 
                targetShifts: state.targetShifts,
                dragSwaps: state.dragSwaps,
                highlights: state.highlights,
                lastInvalidSwap: state.lastInvalidSwap
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(configToExport, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `configuracion_cronograma_${Date.now()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast('Configuración exportada.');
        }

        function handleImportConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);
                    if (importedConfig.residents && importedConfig.daySlots) {
                        importedConfig.residents.forEach(r => {
                            if(!r.targetShifts) r.targetShifts = { weekday: null, weekend: null };
                        });
                        state.residents = importedConfig.residents;
                        state.groups = importedConfig.groups || [];
                        state.holidays = importedConfig.holidays || [];
                        state.daySlots = importedConfig.daySlots || {};
                        state.previousMonthShifts = importedConfig.previousMonthShifts || { lastDay: [], secondLastDay: [] };
                        state.targetShifts = importedConfig.targetShifts || { weekday: 4, weekend: 2};
                        state.dragSwaps = importedConfig.dragSwaps || [];
                        state.highlights = importedConfig.highlights || {};
                        state.lastInvalidSwap = importedConfig.lastInvalidSwap || null;
                        
                        // Cargar valores importados en la UI
                        holidaysInput.value = state.holidays.join(', ');
                        lastDayShiftsInput.value = state.previousMonthShifts.lastDay.join(', ');
                        secondLastDayShiftsInput.value = state.previousMonthShifts.secondLastDay.join(', ');

                        saveState();
                        refreshUIFromState();
                        showToast('Configuración importada exitosamente.');
                    } else {
                        throw new Error('Archivo de configuración inválido.');
                    }
                } catch (error) {
                    showToast('Error al importar el archivo. Asegúrate de que es un archivo de configuración válido.', true);
                }
            };
            reader.readAsText(file);
            importConfigInput.value = ''; // Reset input
        }


        // --- Event Listeners ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === CORRECT_PASSWORD) {
                loginScreen.style.display = 'none';
                appContainer.style.display = 'block';
                init();
            } else {
                errorMessage.textContent = 'Contraseña incorrecta.';
                passwordInput.classList.add('border-red-500');
            }
        });
        
        generateBtn.addEventListener('click', generateAndDisplaySchedule);
        [monthSelect, yearInput].forEach(el => el.addEventListener('change', () => {
            updatePreviousMonthInputs();
            renderSlotsCalendar();
            updateSlotCounters(); // NUEVO
            generateAndDisplaySchedule();
        }));

        // NUEVO: Listener para el campo de feriados
        holidaysInput.addEventListener('change', updateSlotCounters);

        targetWeekdayShiftsInput.addEventListener('change', (e) => { state.targetShifts.weekday = parseInt(e.target.value) || 0; saveState(); showToast('Objetivo de guardias de semana actualizado.'); generateAndDisplaySchedule(); });
        targetWeekendShiftsInput.addEventListener('change', (e) => { state.targetShifts.weekend = parseInt(e.target.value) || 0; saveState(); showToast('Objetivo de guardias de fin de semana actualizado.'); generateAndDisplaySchedule(); });
        
        slotsCalendarGrid.addEventListener('change', (e) => {
            if (e.target.classList.contains('slot-input')) {
                const day = e.target.dataset.day;
                const count = parseInt(e.target.value);
                const year = parseInt(yearInput.value);
                const month = parseInt(monthSelect.value);
                const monthKey = `${year}-${month}`;
                if (!state.daySlots[monthKey]) state.daySlots[monthKey] = {};
                state.daySlots[monthKey][day] = count;
                saveState();
                updateSlotCounters(); // NUEVO: Actualizar contadores al cambiar un cupo
            }
        });
        createGroupBtn.addEventListener('click', () => {
            const name = groupNameInput.value.trim();
            const members = Array.from(groupMembersChecklist.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
            if (name && members.length > 1) {
                state.groups.push({ name, members });
                saveState();
                renderGroupsList();
                groupNameInput.value = '';
                groupMembersChecklist.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
                showToast('Grupo creado.');
            } else {
                showToast('Nombre y al menos 2 miembros requeridos.', true);
            }
        });
        groupsDisplay.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                state.groups.splice(e.target.dataset.index, 1);
                saveState();
                renderGroupsList();
                showToast('Grupo eliminado.');
            }
        });
        addResidentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = newResidentNameInput.value.trim();
            if (newName && !state.residents.some(r => r.name === newName)) {
                const newId = state.residents.length > 0 ? Math.max(...state.residents.map(r => r.id)) + 1 : 0;
                state.residents.push({
                    id: newId, name: newName, status: 'active',
                    preferences: { preferred: [], avoid: [] },
                    blocked: [], avoidResidents: [],
                    equity: { saturdays: 0, sundays: 0, holidays: 0 },
                    manualAssignments: [],
                    targetShifts: { weekday: null, weekend: null }
                });
                saveState();
                refreshUIFromState();
                newResidentNameInput.value = '';
                showToast(`Residente ${newName} añadido.`);
            } else {
                showToast('El nombre no puede estar vacío o ya existe.', true);
            }
        });
        residentList.addEventListener('click', (e) => {
            if(e.target.classList.contains('delete-resident-btn')) {
                const resId = parseInt(e.target.dataset.id);
                state.residents = state.residents.filter(r => r.id !== resId);
                state.groups.forEach(group => { group.members = group.members.filter(id => id !== resId); });
                state.groups = state.groups.filter(group => group.members.length > 1);
                saveState();
                refreshUIFromState();
                showToast('Residente eliminado.');
            }
        });
        modalSaveBtn.addEventListener('click', savePreferences);
        modalCloseBtn.addEventListener('click', () => prefModal.style.display = 'none');
        residentStatusSelect.addEventListener('change', (e) => toggleModalSections(e.target.value));
        dayModalSaveBtn.addEventListener('click', saveDayPreference);
        dayModalCloseBtn.addEventListener('click', () => dayModal.style.display = 'none');
        residentQuickFilter.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const residentName = e.target.dataset.residentName;
                const index = state.filteredResidents.indexOf(residentName);
                if (index > -1) { state.filteredResidents.splice(index, 1); } else { state.filteredResidents.push(residentName); }
                renderQuickFilter();
                if(currentSchedule && !currentSchedule.error) { renderCalendar(currentSchedule.schedule, parseInt(yearInput.value), parseInt(monthSelect.value)); }
            }
        });

        // --- Drag & Drop and Revert Logic ---
        let draggedItem = null;
        calendarGrid.addEventListener('dragstart', e => {
            if (e.target.classList.contains('resident-chip')) {
                draggedItem = e.target;
                setTimeout(() => { e.target.classList.add('dragging'); }, 0);
            }
        });
        calendarGrid.addEventListener('dragend', e => {
            if(draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        });
        calendarGrid.addEventListener('dragover', e => {
            e.preventDefault();
            const targetCell = e.target.closest('[data-day]');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if (targetCell) {
                targetCell.classList.add('drag-over');
            }
        });
        calendarGrid.addEventListener('dragleave', e => {
            e.target.closest('[data-day]')?.classList.remove('drag-over');
        });
        calendarGrid.addEventListener('drop', e => {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const dropTarget = e.target.closest('.resident-chip');
            if (!dropTarget || !draggedItem || dropTarget === draggedItem) { return; }
            
            const sourceResName = draggedItem.dataset.residentName;
            const sourceDay = parseInt(draggedItem.dataset.day);
            const targetResName = dropTarget.dataset.residentName;
            const targetDay = parseInt(dropTarget.dataset.day);

            if (sourceDay === targetDay) return;

            const schedule = currentSchedule.schedule;
            const sourceDayIndex = schedule[sourceDay].indexOf(sourceResName);
            const targetDayIndex = schedule[targetDay].indexOf(targetResName);
            
            if (sourceDayIndex > -1 && targetDayIndex > -1) {
                schedule[sourceDay][sourceDayIndex] = targetResName;
                schedule[targetDay][targetDayIndex] = sourceResName;
            }

            recalculateStatsAndUpdateUI(schedule, false);
            const swapStatus = validateSwap(sourceResName, sourceDay, targetResName, targetDay);

            if (swapStatus !== 'duplicate') {
                state.dragSwaps.push({ res1Name: sourceResName, res1Day: sourceDay, res2Name: targetResName, res2Day: targetDay, status: swapStatus });
            }
            
            renderCalendar(schedule, parseInt(yearInput.value), parseInt(monthSelect.value));
            recalculateStatsAndUpdateUI(schedule); 
            renderDragSwapsHistory();
            saveState();
        });
        calendarGrid.addEventListener('click', e => {
            if (e.target.classList.contains('revert-btn')) {
                if (!state.lastInvalidSwap) return;

                const { res1Name, res1Day, res2Name, res2Day } = state.lastInvalidSwap;
                const schedule = currentSchedule.schedule;
                
                // Revert the swap
                const currentRes1Index = schedule[res2Day].indexOf(res1Name);
                if (currentRes1Index > -1) schedule[res2Day][currentRes1Index] = res2Name;
                
                const currentRes2Index = schedule[res1Day].indexOf(res2Name);
                if (currentRes2Index > -1) schedule[res1Day][currentRes2Index] = res1Name;

                state.highlights = {};
                state.lastInvalidSwap = null;
                
                renderCalendar(schedule, parseInt(yearInput.value), parseInt(monthSelect.value));
                recalculateStatsAndUpdateUI(schedule);
                saveState();
                showToast('Cambio inválido revertido.');
            }
        });
        
        exportIcalBtn.addEventListener('click', handleICalExport);
        exportConfigBtn.addEventListener('click', handleExportConfig);
        importConfigInput.addEventListener('change', handleImportConfig);
        exportPngBtn.addEventListener('click', () => { html2canvas(document.getElementById('schedule-container'), {scale: 2}).then(canvas => { const link = document.createElement('a'); link.download = `cronograma.png`; link.href = canvas.toDataURL(); link.click(); }); });
        exportPdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const scheduleElement = document.getElementById('schedule-container');

            const getImageBase64 = (src, callback) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    callback(dataURL);
                };
                img.onerror = () => {
                    console.error("No se pudo cargar el logo. Asegúrate que 'notti.png' está en el mismo directorio.");
                    callback(null);
                };
                img.src = src;
            };

            const generatePdf = (logoBase64) => {
                if (logoBase64) {
                    pdf.addImage(logoBase64, 'PNG', 10, 5, 30, 15);
                }

                html2canvas(scheduleElement, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const ratio = canvas.width / canvas.height;
                    let imgWidth = pdfWidth - 20;
                    let imgHeight = imgWidth / ratio;
                    if (imgHeight > pdfHeight - 40) {
                        imgHeight = pdfHeight - 40;
                        imgWidth = imgHeight * ratio;
                    }
                    pdf.addImage(imgData, 'PNG', 10, logoBase64 ? 25 : 10, imgWidth, imgHeight);
                    
                    if (includeSummaryPdf.checked) {
                        pdf.addPage();
                        pdf.setFontSize(16);
                        pdf.text('Resumen de Guardias por Residente', 10, 15);
                        pdf.setFontSize(10);
                        let y = 25;
                        state.residents.forEach(res => {
                            const card = document.querySelector(`p[data-id="${res.id}"]`).parentElement;
                            const shiftsText = card.querySelector('.text-sm.text-gray-600')?.innerText || 'N/A';
                            pdf.text(`${res.name}: ${shiftsText}`, 10, y);
                            y += 7;
                            if (y > 200) { pdf.addPage(); y = 15; }
                        });
                    }
                    pdf.save('cronograma.pdf');
                });
            };
            
            getImageBase64('notti.png', generatePdf);
        });
    });
    </script>
</body>
</html>



